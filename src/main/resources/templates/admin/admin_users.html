<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <div th:replace="fragments/head :: head('Uniza Studio - Správa používateľov',true)"></div>
    <body class="bg-light">
        <div th:replace="fragments/header :: header"></div>
        <main class="container my-4">
            <h2>Správa používateľov</h2>
            <input type="text" id="userFilter" class="form-control my-3" placeholder="Filter používateľov..." onkeyup="filterUsers()">
            <table class="table table-bordered table-hover mt-4">
                <thead class="table bg-dark">
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Nickname</th>
                    <th>Admin</th>
                    <th>Akcie</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${users}">
                    <td th:text="${user.id}">1</td>
                    <td th:text="${user.email}">email@example.com</td>
                    <td th:text="${user.nickname}">nickname</td>
                    <td>
                        <span th:text="${user.isAdmin} ? 'Áno' : 'Nie'">Nie</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary open-edit-modal bg-dark"
                                th:attr="data-user-id=${user.id},
                         data-email=${user.email},
                         data-nickname=${user.nickname},
                         data-is-admin=${user.isAdmin}">
                            <i class="bi bi-pencil bg-dark"></i>
                        </button>
                        <a th:href="@{'/admin/delete-user'(id=${user.id})}" class="btn btn-sm btn-danger"
                           th:attr="onclick=|return confirm('Naozaj chcete vymazať používateľa ' + '${user.nickname}' + '?');|">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
            <div th:replace="fragments/modal :: genericModal"></div>
        </main>
        <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
        <script th:src="@{/js/logged_in.js}"></script>
        <script>
            function openEditModal(userId, email, nickname, phone, isAdmin) {
                document.getElementById("modalContent").innerHTML = `
                    <form id="editUserForm">
                        <input type="hidden" name="id" value="${userId}">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="${email}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nickname</label>
                            <input type="text" class="form-control" name="nickname" value="${nickname}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Admin</label>
                            <select class="form-control" name="isAdmin">
                                <option value="true" ${isAdmin ? 'selected' : ''}>Áno</option>
                                <option value="false" ${!isAdmin ? 'selected' : ''}>Nie</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nové heslo (nepovinné)</label>
                            <input type="password" class="form-control" name="password">
                        </div>
                    </form>
                `;

                document.getElementById("genericModalLabel").innerText = "Upraviť používateľa";
                document.getElementById("modalSaveButton").onclick = submitEditUser;


                /* global bootstrap */
                let modalElement = document.getElementById("genericModal");
                let modalInstance = new bootstrap.Modal(modalElement);
                modalInstance.show();

            }

            function submitEditUser() {
                let formData = new FormData(document.getElementById("editUserForm"));
                let jsonData = Object.fromEntries(formData.entries());

                fetch('/admin/edit-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonData),
                    credentials: 'include'
                })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            return response.text().then(text => { throw new Error(text); });
                        }
                    })
                    .catch(error => {
                        console.error("Chyba pri odoslaní požiadavky:", error);
                        alert("Chyba pri editácii používateľa: " + error.message);
                    });
            }

            function filterUsers() {
                let input = document.getElementById("userFilter");
                let filter = input.value.toLowerCase();
                let rows = document.querySelectorAll("tbody tr");

                rows.forEach(row => {
                    let textContent = row.innerText.toLowerCase();
                    row.style.display = textContent.includes(filter) ? "" : "none";
                });
            }

            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".open-edit-modal").forEach(function (button) {
                    button.addEventListener("click", function () {
                        let userId = this.getAttribute("data-user-id");
                        let email = this.getAttribute("data-email");
                        let nickname = this.getAttribute("data-nickname");
                        let phone = this.getAttribute("data-phone");
                        let isAdmin = this.getAttribute("data-is-admin") === "true";

                        openEditModal(userId, email, nickname, phone, isAdmin);
                    });
                });
            });
        </script>
    </body>
</html>
